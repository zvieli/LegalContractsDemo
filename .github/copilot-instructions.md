# Copilot Instructions for LegalContractsDemo

## Project Overview
- **Purpose:** Smart contract templates (NDA & Rent) with AI-powered arbitration via Chainlink Functions and Ollama LLM integration.
- **Architecture:**
  - **Smart Contracts:** Located in `contracts/` (NDATemplate, EnhancedRentContract, ArbitrationService, etc.)
  - **Backend:** Node.js server (see `server/`) integrates with Ollama LLM for arbitration; simulation fallback for reliability.
  - **Frontend:** Vite + MetaMask (`front/`), auto-integrates ABIs and config from backend/scripts.
  - **AI Arbitration:** Arbitration verdicts are generated by LLM (Ollama) and relayed via Chainlink Functions to smart contracts.

## Key Workflows
- **Deployment:** Use `scripts/deploy.js` for unified deployment and wiring of all contracts and relationships. Avoid legacy scripts.
- **Testing:**
  - Run Hardhat node: `npx hardhat node`
  - Deploy contracts: `npx hardhat run scripts/deploy.js --network localhost`
  - Smoke test: `npx hardhat run scripts/smokeTest.js --network localhost`
  - Frontend E2E: `cd front && npm test -- tests/e2e/enhanced.rent.e2e.spec.ts`
- **Frontend Contract Integration:** ABIs are auto-copied to `front/src/utils/contracts` after deployment.
- **Evidence Submission:**
  - Use `submitEvidenceWithDigest` when possible; fallback to `submitEvidence` for older contracts.
  - Evidence is stored as keccak256 digest, not raw CIDs or ciphertext.
  - Canonicalization and digest logic: see `front/src/utils/evidenceCanonical.js`.
- **Recipient Key Registry:**
  - Sync public keys using `tools/admin/sync-recipient-keys.js`.
  - Registry file: `recipient_pubkeys.json` (never store private keys).

## Conventions & Patterns
- **ArbitrationService:** Central contract for applying resolutions; templates are deployed via `ContractFactory` with immutable arbitration settings.
- **Security:** Never commit secrets; `.env` is git-ignored. Admin decryption tools are for trusted environments only (`tools/admin/`).
- **Gas Optimization:** Merkle evidence batching in EnhancedRentContract; always prefer digest-based evidence anchoring.
- **Event Handling:** Frontend listens for `DisputeAppliedCapped` and `ResolutionApplied` events for real-time updates.

## Integration Points
- **Chainlink Functions:** Requires subscription ID, router address, DON ID, and oracle key in `.env`.
- **Ollama LLM:** Backend connects to local Ollama instance for arbitration; health check at `/api/v7/arbitration/ollama/health`.

## References
- **Docs:** See `docs/` for specs, guides, and optimization notes.
- **Admin Tools:** See `tools/admin/README.md` for decryption and key sync utilities.
- **Frontend:** `front/` for UI, contract integration, and E2E tests.
- **Backend:** `server/` for Node.js arbitration logic.

---

**For AI agents:**
- Always use the unified deployment and wiring scripts.
- Prefer digest-based evidence anchoring and canonicalization.
- Never expose or commit secrets or private keys.
- Reference the latest contract ABIs and event patterns for integration.
- Follow the ArbitrationService â†’ Arbitrator flow for dispute resolution.
