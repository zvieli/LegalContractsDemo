name: IPFS Pin-server CI

on:
  push:
    paths:
      - 'tools/ipfs/**'
      - '.github/workflows/ipfs-pin-server.yml'
  pull_request:
    paths:
      - 'tools/ipfs/**'

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Build and run pin-server with docker-compose
        env:
          PIN_SERVER_SYMM_KEY: devkey
          PIN_SERVER_API_KEY: admin
        run: |
          cd tools/ipfs
          docker compose -f docker-compose.yml build --no-cache
          docker compose -f docker-compose.yml up -d

      - name: Wait for server to be ready
        run: |
          # Try connecting to port 8080 for up to 30s
          for i in {1..30}; do
            if curl -sS http://127.0.0.1:8080/health >/dev/null 2>&1; then
              echo 'server ready'; break
            fi
            sleep 1
          done

      - name: Run pin-server test harness
        run: |
          node tools/ipfs/test_run_all.js

      - name: Tear down docker-compose
        if: always()
        run: |
          cd tools/ipfs
          docker compose -f docker-compose.yml down --volumes --remove-orphans
